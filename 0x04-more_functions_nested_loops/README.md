More function, more nested loop
